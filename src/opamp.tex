\documentclass[main.tex]{subfiles}
\begin{document}

\section{Solve the transfer function for the following circuit.}

% \noindent Note: in a real interview scenario, it's reasonable to only expect just one of these circuits.
% Numerous circuits were initially proposed for this question for the sake of building intuition and the showing first principles approach, however, it is optimal to show a single circuit to reduce scope creeping this question

% TODO : move extra op-amp circuits to the appendix so people can solve them if they want to. idk maybe it's not worth putting into the appendix like it did take a bit to draw these but fuck it like who cares :d im learning how to write well.
% \begin{figure}[H]
%     \begin{center}
%         \begin{minipage}{0.45\textwidth}
%             \centering
%             \begin{circuitikz}[american]
%                 \draw (0,0) node[left]{$V_{in}$} to[short] ++ (1,0)
%                     node[op amp, noinv input up, anchor=+](op-amp){}
%                     (op-amp.-) -- ++(0,-1) coordinate(FB)
%                     (FB) to[short] (FB -| op-amp.out) -- (op-amp.out)
%                     to [short] ++(1,0) node[right]{$V_{out}$};
%             \end{circuitikz}
%             \caption{Circuit A}
%             \label{fig:unity-amp}
%         \end{minipage}%
%         \hfill%
%         \begin{minipage}{0.45\textwidth}
%             \centering
%             \begin{circuitikz}[american]
%                 \draw (0, 0) node[left]{$V_{in}$};
%                 \draw (0, 0) to[resistor, l=$R_i$] (2, 0);
%                 \draw (2, 0) node[op amp, anchor=-](op-amp){};
%                 \draw (op-amp.+) node[ground]{};
%                 \draw (2, 0) -- (2, 1);
%                 \draw (2, 1) to[resistor, l=$R_f$] (4.5, 1);
%                 \draw (4.5, 1) -- (4.5, -0.5);
%                 \draw (op-amp.out) to [short] ++ (0.5, 0) node[right]{$V_{out}$};
%             \end{circuitikz}
%             \caption{Circuit B}
%             \label{fig:inverting_amp}
%         \end{minipage}
%     \end{center}
% \end{figure}
% \begin{figure}[H]
%     \begin{center}
%         \begin{minipage}{0.45\textwidth}
%             \centering
%             \begin{circuitikz}[american, transform shape]
%                 \draw (0,0) node[left]{$V_{in}$} to[short] ++ (1,0)
%                     node[op amp, noinv input up, anchor=+](op-amp){}
%                     (op-amp.-) -- ++(0,-1) coordinate(FB)
%                     to[R=$R_i$] ++(0,-2) node[ground]{}
%                     (FB) to[R=$R_f$] (FB -| op-amp.out) -- (op-amp.out)
%                     to [short] ++(1,0) node[right]{$V_{out}$};
%             \end{circuitikz}
%             \caption{Circuit C}
%             \label{fig:non_inverting_amp}
%         \end{minipage}%
%         \hfill%
%         \begin{minipage}{0.45\textwidth}
%             \centering
%             \begin{circuitikz}[american]
%                 \draw (0, 0) node[left]{$V_{in+}$};
%                 \draw (0, 0) to[resistor, l=$R_1$, i=$I_{1}$] (2, 0);
%                 \draw (2, 0) node[op amp, anchor=-](op-amp){};
%                 \draw (2, 0) -- (2, 1);
%                 \draw (2, 1) to[resistor, l=$R_3$] (4.5, 1);
%                 \draw (4.5, 1) -- (4.5, -0.5);
%                 \draw (op-amp.out) to [short] ++ (0.5, 0) node[right]{$V_{out}$};
%                 \draw (0, -1) node[left]{$V_{in-}$};
%                 \draw (0, -1) to[resistor, l=$R_2$, i=$I_{2}$] (2, -1);
%                 \draw (2, -1) to[resistor, l=$R_4$] (2, -3);
%                 \draw (2, -3) node[ground]{};
%             \end{circuitikz}
%             \caption{Circuit D}
%             \label{fig:difference_amp}
%         \end{minipage}
%     \end{center}
% \end{figure}

\begin{figure}[H]
    \begin{center}
        \begin{circuitikz}[american, transform shape]
            \draw (0,0) node[left]{$V_{in}$} to[short] ++ (1,0)
                node[op amp, noinv input up, anchor=+](op-amp){}
                (op-amp.-) -- ++(0,-1) coordinate(FB)
                to[R=$R_i$] ++(0,-2) node[ground]{}
                (FB) to[R=$R_f$] (FB -| op-amp.out) -- (op-amp.out)
                to [short] ++(1,0) node[right]{$V_{out}$};
        \end{circuitikz}
        \caption{Given Circuit}
        \label{fig:non_inverting_amp}
        % TODO : remove weird space after figure, idk how to do this correctly, need to figure it out eventually to save space on the page.
    \end{center}
\end{figure}
% Chose this circuit because it can be simplified into unity gain amplifier and isn't as complicated as the difference amplifier

\spoilerline

\subsection{Operational Amplifiers}
Ideal operational amplifiers (\textit{op-amps}) are active devices characterized by the following equations:

\begin{equation}
    \begin{aligned}
        V_{out} &= A \cdot (V_{+} - V_{-}) \quad \text{where} \quad A \to \infty, \\
        I_{+} &= I_{-} = 0.
    \end{aligned}
    \label{eq:op-amp-governing-equations}
\end{equation}

\begin{figure}[H]
    \begin{center}
        \begin{circuitikz}[american, transform shape]
            \draw (0,0) node[op amp, yscale=-1] (opamp) {};
            \draw (opamp.out) -- ++ (0.5, 0) node[right]{$V_{out}$};
            \draw (opamp.out) to[short, i=$I_{out}$] ++ (0.5, 0);
            \draw (opamp.+) -- ++ (-0.5, 0) node[left]{$V_{+}$} to[short, i=$I_{+}$] (opamp.+);
            \draw (opamp.-) -- ++ (-0.5, 0) node[left]{$V_{-}$} to[short, i=$I_{-}$] (opamp.-);
        \end{circuitikz}
        \caption{Labelled Op-amp}
        \label{fig:labelled_op-amp}
        % TODO : remove weird space after figure, idk how to do this correctly, need to figure it out eventually to save space on the page.
    \end{center}
\end{figure}

\subsubsection{Virtual Short}
\noindent When an op-amp is connected in a negative feedback configuration, the inputs ($V_{+}$ and $V_{-}$) are considered "virtually shorted", meaning $V_{+} = V_{-}$. Negative feedback in an op-amp circuit means there is a current path from it's output, $V_{out}$, to it's inverting terminal, $V_{-}$.

\subsection{Solving}
\noindent When analyzing circuits, begin by defining equations for simple elements and build from there. In this case for both resistors ohms law can be applied which gives $V_{out} - V_{-} = I \cdot R_f$ and $V_{-} = I \cdot R_i$. Note in this case that because $I_{-} = 0$ so the current through resistor $R_f$ is the same as the current through $R_i$. \newline

\newnoindentpara Next, because $R_f$ connects a current path from $V_{out}$ to $V_{-}$ the virtual short assumption holds so for the op-amp $V_{+} = V_{-}$. From the circuit $V_{in} = V_{+}$ is drawn so $V_{in} = V_{+} = V_{-}$. This conclusion can be substituted into the resistor equations to get $V_{out} - V_{in} = I \cdot R_f$ and $V_{in} = I \cdot R_i$. \newline

\newnoindentpara These equations can be substituted into each other to cancel out $I$ and algebraically rearranged to determine $\frac{V_{out}}{V_{in}} = 1 + \frac{R_f}{R_i}$. This solution for $\frac{V_{out}}{V_{in}}$ is known as the transfer function of the circuit. The concept of a transfer function is used to analyze numerous circuits. 

\subsubsection{Intuition}
To understand this circuit better, consider how this circuit operates.
\begin{itemize}
    \item Because negative resistors don't exist, $R_f > 0$ and $R_i > 0$, $\frac{V_{out}}{V_{in}} > 1$ always. As the gain of the circuit is always positive, this circuit is referred to as a Non-inverting Amplifier. 
    \item When $R_f = R_i = R$ the transfer function simplifies into $\frac{V_{out}}{V_{in}} = 2$.
    \item When $R_f >> R_i$ the gain becomes very large, $\frac{V_{out}}{V_{in}} \approx \inf$.
    \item When $R_i >> R_f$ the gain approaches unity, $\frac{V_{out}}{V_{in}} \approx 1$.
\end{itemize}

\subsection{Unity Gain Amplifier}
A special case of this circuit occurs when $R_f$ is replaced with a short circuit, $R_f = 0$, and $R_i$ is replaced with an open circuit, $R_i = \inf$ as drawn in figure \ref{fig:unity-amp}.

\begin{figure}[H]
    \begin{center}
        \begin{circuitikz}[american, transform shape]
        \draw (0,0) node[left]{$V_{in}$} to[short] ++ (1,0)
            node[op amp, noinv input up, anchor=+](op-amp){}
            (op-amp.-) -- ++(0,-1) coordinate(FB)
            (FB) to[short] (FB -| op-amp.out) -- (op-amp.out)
            to [short] ++(1,0) node[right]{$V_{out}$};
        \end{circuitikz}
        \caption{Unity Gain Amplifier Circuit}
        \label{fig:unity-amp}
    \end{center}
\end{figure}

\noindent In this case the transfer function becomes unity, $\frac{V_{out}}{V_{in}} = 1$ which can be simplified into $V_{in} = V_{+}$. \newline

\newnoindentpara This circuit acts as a current buffer. Because $I_{V_{+}} = 0$ and $V_{in} = V_{+}$ we see that $I_{V_{in}} = 0$ so the circuit doesn't load the input at all. However, the op amp is capable of providing however much current is required to any load! 


% the text below that i interleaved with math is quite hard to read, consider a better approach to demonstrate these equarions
% TODO use appendix if I want to do extra proofs and stuff 
% \subsection{Solutions}
% Given all of the circuit configurations feature negative feedback, the virtual short assumption can be applied to simplify the analysis (that is, $V_{+} = V_{-}$).

% \subsubsection{Circuit A: Unity Gain Amplifier}
% From the drawn circuit we see $V_{in} = V_{+}$ and $V_{out} = V_{-}$. For the op-amp we can apply $V_{out} = A \cdot (V_{+} - V_{-}) = A \cdot (V_{in} - V_{out}) = A \cdot V_{in} - A \cdot V_{out}$ which can be rearranged into $V_{out} + A \cdot V_{out} = A \cdot V_{in}$, $V_{out} \cdot (1 + A) = A \cdot V_{in}$. Now to solve for the transfer function gives $\frac{V_{out}}{V_{in}} = \frac{A}{1+A}$. Recall that $A \approx \inf$ so the $1$ in the denominator becomes insignificant leading to $\frac{V_{out}}{V_{in}} = 1$ or $V_{out} = V_{in}$.

% This circuit can also be solved easily with the virtual short assumption, $V_{+} = V_{-}$, by substituting in $V_{in} = V_{+}$ and $V_{out} = V_{-}$, the solution is trivially $V_{out} = V_{in}$.

% This circuit acts as a current buffer. Because $I_{V_{+}} = 0$ and $V_{in} = V_{+}$ we see that $I_{V_{in}} = 0$ so the circuit doesn't load the input at all. However, the op amp is capable of providing however much current is required to any load! 

% \subsubsection{Circuit B: Inverting Amplifier}
% From the circuit $V_{+} = 0$ and there is a current path $I$ from $V_{in}$ to $V_{out}$. Recall that $I_{in} = 0$ so no current goes into the op-amp input pins. Analyzing the resistors gives $V_{in} - V_{-} = I \cdot R_i$ and $V_{-} - V_{out} = I \cdot R_f$. Note that the resistors could be solved with $I$ in the reverse direction as long as equations are internally consistent: $V_{out} - V_{-} = I \cdot R_f$ and $V_{-} - V_{in} = I \cdot R_i$. Next the resistor equations can be substituted into each other to cancel out $I$ so $\frac{V_{out} - V_{-}}{R_f} = \frac{V_{-} - V_{in}}{R_i}$. Simplifying this gives $V_{out} \cdot R_i - V_{-} \cdot R_i = V_{-} \cdot R_f - V_{in} \cdot R_f$. 

% Next $V_{out} = A \cdot (V_{+} - V_{-})$ can be applied where $V_{+} = 0$ from the circuit so $V_{out} = -A \cdot V_{-}$ and $V_{-} = -\frac{V_{out}}{A}$. This can be substituted into the resistor equation $V_{out} \cdot R_i - V_{-} \cdot R_i = V_{-} \cdot R_f - V_{in} \cdot R_f$ to get $V_{out} \cdot R_i - (-\frac{V_{out}}{A}) \cdot R_i = (-\frac{V_{out}}{A}) \cdot R_f - V_{in} \cdot R_f$. Next this can be rearranged to find the transfer function: $V_{out} \cdot R_i + \frac{V_{out} \cdot R_i}{A} = -\frac{V_{out} \cdot R_f}{A} - V_{in} \cdot R_f$, $V_{out} \cdot R_i \cdot A + V_{out} \cdot R_i = -V_{out} \cdot R_f - V_{in} \cdot R_f \cdot A$, $V_{out} \cdot R_i \cdot A + V_{out} \cdot R_i + V_{out} \cdot R_f = - V_{in} \cdot R_f \cdot A$, $V_{out} \cdot (R_i \cdot A + R_i + R_f) = - V_{in} \cdot R_f \cdot A$, and $\frac{V_{out}}{V_{in}} = \frac{-R_f \cdot A}{R_i \cdot A + R_i + R_f} = -\frac{R_f}{R_i + \frac{R_i}{A} + \frac{R_f}{A}}$. This can be simplified assuming $A \approx \inf$ so $\frac{1}{A} \approx 0$ resulting in $\frac{V_{out}}{V_{in}} = -\frac{R_f}{R_i}$. 

% Alternatively using the virtual short assumption, $V_{+} = V_{-}$, after seeing negative feedback in the circuit. From the circuit $V_{+} = 0$ so $V_{-} = V_{+} = 0$. Plugging this into the resistor equation gives $V_{out} \cdot R_i - 0 \cdot R_i = 0 \cdot R_f - V_{in} \cdot R_f$, $V_{out} \cdot R_i = - V_{in} \cdot R_f$, and $\frac{V_{out}}{V_{in}} = -\frac{R_f}{R_i}$. This approach is much simpler than solving the entire circuit with $A$ and will be used to solve the subsequent circuits as they also exhibit negative feedback.  

% \subsubsection{Circuit C: Non-inverting Amplifier}
% From the circuit $V_{in} = V_{+}$. From the resistors, $V_{out} - V_{-} = I \cdot R_f$ and $V_{-} - 0 = I \cdot R_i$. Using substitution to cancel out $I$ gives $\frac{V_{out} - V_{-}}{R_f} = \frac{V_{-}}{R_i}$ and $V_{out} \cdot R_i - V_{-} \cdot R_i = V_{-} \cdot R_f$.

% While this could be solved using $V_{out} = A \cdot (V_{+} - V_{-})$, this solution will jump to applying the virtual short assumption, $V_{+} = V_{-}$, because negative feedback is present in this configuration. This assumption gives $V_{-} = V_{+} = V_{in}$ which gives $V_{out} \cdot R_i - V_{in} \cdot R_i = V_{in} \cdot R_f$, $V_{out} \cdot R_i = V_{in} \cdot R_f + V_{in} \cdot R_i$, and $\frac{V_{out}}{V_{in}} = \frac{R_f + R_i}{R_i} = frac{R_f}{R_i} + \frac{R_i}{R_i} = 1 + \frac{R_f}{R_i}$. 

% Notice when $R_i = \inf \Omega$ and $R_f = 0 \Omega$ the non-inverting amplifier circuit becomes a unity gain amplifier circuit and the transfer function mathematically aligns with this conclusion as $\frac{R_f}{R_i} = \frac{0}{\inf} = 0$ so $\frac{V_{out}}{V_{in}} = 1$. 

% \subsubsection{Circuit D: Difference Amplifier}
% Each resistor can be analyzed using Ohm's law: 
% \begin{itemize}
%     \item $V_{in+} - V_{-} = I_1 \cdot R_1$
%     \item $V_{-} - V_{out} = I_1 \cdot R_3$
%     \item $V_{in-} - V_{+} = I_2 \cdot R_2$
%     \item $V_{+} - 0 = I_2 \cdot R_4$
% \end{itemize}
% Substituting to cancel $I_1$ and $I_2$ gives:
% \begin{itemize}
%     \item $\frac{V_{in+} - V_{-}}{R_1} = \frac{V_{-} - V_{out}}{R_3}$
%     \item $\frac{V_{in-} - V_{+}}{R_2} = \frac{V_{+}}{R_4}$
% \end{itemize}
% As negative feedback is depicted via $R_3$ connecting $V_{out}$ and $V_{-}$ the virtual short assumption holds for this circuit so $V_{+} = V_{-}$. 
% \begin{itemize}
%     \item $(V_{in+} - V_{+}) \cdot R_3 = (V_{+} - V_{out}) \cdot R_1$
%     \item $(V_{in-} - V_{+}) \cdot R_4 = V_{+} \cdot R_2$
% \end{itemize}
% Now these can be substituted into each other to cancel out $V_{+}$. 


% \subsection{Non-idealities}
% While most interview questions focus on ideal op-amps, real op-amps suffer from numerous non-idealities. The most important of which should be understood to aid in circuit design questions and are described below. 

% \subsubsection{Saturation}
% Saturation occurs when 
% For a rail to rail op-amp, $V_{out}$ is bounded by the rails, $V_{ee}$ and $V_{cc}$, such that $V_{ee} < V_{out} < V_{cc}$. % more details required here to explain

% \subsubsection{Input Offset Voltage}
% The input offset voltage is the minimum voltage difference that an amplifier can detect between $V_{+}$ and $V_{-}$ input pins. 

% \subsubsection{Input Bias Current}
% Input bias current is current, $I_{in}$, into $V_{+}$ and $V_{-}$. This current is usually very small, but has an affect on the circuit! 

\subsection{Follow-ups}
\begin{itemize}
    \item What is an inverting amplifier?
    \item What is a difference amplifier?
    \item Describe the non-idealities of op-amps and how to compensate for them? % Saturation, Input offset voltage, input bias current 
    \item Why are non-inverting amplifiers preferred over inverting amplifiers? % Input Impedance
    % \item What is an Instrumentation Amplifier? When would you use it? % Non-inverting amplifier's buffering a difference amplifier
\end{itemize}

\end{document}
