\documentclass[main.tex]{subfiles}
\begin{document}

\section{How would you sense the voltage of a battery with a microcontroller?} % @daniel consider a reword: "Describe the electrical circuitry required to measure the voltage of a battery with an ADC", and add a small clarification that the battery voltage is higher than the microcontroller's ADC reference voltage (not always the case, but a common scenario).
\spoilerline

\noindent A voltage divider circuit can be used to scale the voltage of the battery by a fixed ratio, specified by the two resistors, such that an analog-to-digital converter on the microcontroller can sample the signal safely.

\begin{figure}[h!]
\begin{center}
\begin{circuitikz}[american]
  \draw (-1, 4) node[anchor=east] {$V_{in}$} -- (0, 4) -- (0, 3); 
  \draw (0, 3) to[resistor, l=$R_t$] (0, 1.5) to[resistor, l=$R_b$] (0, 0);
  \draw (0, 0) node[ground]{};
  \draw (0, 1.5) -- (1, 1.5) node[right] {$V_{out}$};
  \label{ct:voltage_divider}
\end{circuitikz}
\caption{Voltage Divider Circuit}
\end{center}
\end{figure}

\subsection{Motivation}
Electronics systems often require high power actuators and batteries to operate so relatively high battery bus voltages are often selected by engineers. Microcontrollers require low input voltages (i.e. 1.8V, 3.3V, 5V) to operate to reduce power consumption and transistor size. As chemical batteries charge and discharge the voltage of that battery varies due to state of charge and other factors. For this reason, microcontrollers in embedded systems often need to sense the voltage of a battery!

\subsection{Voltage Divider Circuit}
Ohm's Law relates the voltage across a resistor, $V$, to current, $I$, by $V = I \cdot R$. Applying Ohm's Law to each of the two resistors shown results in equations \eqref{eq:ohms_law_top} and \eqref{eq:ohms_law_bot}. Because the resistors are in series, the current, ($I$), flowing through them is the same (i.e. $I_{R_t} = I_{R_b} = I$).
\begin{equation}
    \begin{aligned}[b]
        V_{in} - V_{out} = I \cdot R_t \\
        I = \frac{V_{in} - V_{out}}{R_t}
    \end{aligned}
    \label{eq:ohms_law_top}
\end{equation}

\begin{equation}
    \begin{aligned}
        V_{out} - 0 = I \cdot R_b \\
        I = \frac{V_{out}}{R_b}
    \end{aligned}
    \label{eq:ohms_law_bot}
\end{equation}

\noindent Solving the system of equations to eliminate $I$ gives \eqref{eq:voltage_divider} as follows. 

\begin{equation}
    \begin{aligned}[b]
        \frac{V_{out}}{R_b} &= \frac{V_{in} - V_{out}}{R_t} \\
        V_{out} \cdot R_t &= R_b \cdot (V_{in} - V_{out}) \\
        V_{out} \cdot R_t &= V_{in} \cdot R_b - V_{out} \cdot R_b \\
        V_{out} \cdot R_t + V_{out} \cdot R_b &= V_{in} \cdot R_b \\
        V_{out} \cdot (R_t + R_b) &= V_{in} \cdot R_b \\
        \frac{V_{out}}{V_{in}} &= \frac{R_b}{R_t + R_b}
    \end{aligned}
    \label{eq:voltage_divider}
\end{equation}
This indicates for a given $V_{in}$, based on the values chosen for $R_t$ and $R_b$ where $R_t > 0 \ \Omega$ and $R_b > 0 \ \Omega$, $V_{out}$ is set such that $V_{out}$ < $V_{in}$, and is scaled by a ratio determined by $R_t$ and $R_b$. Given a maximum ADC voltage ($V_{out}$) and a maximum battery voltage ($V_{in}$), a desired ratio between $R_t$ and $R_b$ can be determined. However, there are additional considerations in selecting $R_t$ and $R_b$, as the voltage divider circuit draws current proportional to the sum of its resistance ($R_{sum} = R_{t} + R_{b}$). Recall that resistor power dissipation is given by equation \ref{eq:resistor_power} below:
\begin{equation} % @daniel This equation is seems slightly extraneous, consider removing it and leaving just the text about how it draws current and power dissipation is bad?
    P = V * I = \frac{V * V}{R} = I * I * R 
    \label{eq:resistor_power}
\end{equation} 
Note that the input voltage of the battery is fixed so if $R_{sum}$ is too small then power dissipation increases rapidly. This power dissipation occurs constantly and can be significantly wasteful. If $R_{sum}$ is too large then the current flowing in the resistor divider is so small that noise coupling into the signal or input bias current into the ADC can result in significant measuring error. A common value selected for $I$ is ~1mA of current to flow in a sensing resistor divider, though different values may be seen based on the application. This boils down to \eqref{eq:divider_current}. 
\begin{equation} % @daniel can we remove the {nominal} subscript?
    R_t + R_b = R_{sum} = \frac{V_{in_{nominal}}}{I} = \frac{V_{in_{nominal}}}{1 \ \mathrm{mA}}
    \label{eq:divider_current}
\end{equation} 

\subsection{Voltage Divider Intuition}
Consider a few specific cases of this circuit to help build intuition to approach problems featuring the voltage divider.
\begin{itemize}
    \item A simple case of the voltage divider circuit is when $R_t = R_b = R$ where $\frac{V_{out}}{V_{in}} = \frac{R}{R+R} = \frac{R}{2*R} = \frac{1}{2}$ which means $V_{in} = 2 * V_{out}$ or $V_{out} = \frac{V_in}{2}$.
    \item Because $R_t > 0$ and $R_b > 0$ are required (as negative resistors do not exist), in all cases of the circuit being employed we observe that $0 < \frac{V_{out}}{V_{in}} < 1$ meaning the voltage divider always scales a voltage down from it's input. 
    \item This circuit assumes no source impedance from $V_{in}$ and no loading connected to $V_{out}$. We will see later that this assumption is not always valid. 
\end{itemize}

\subsection{Pin Overvoltage}
Microcontroller pins often feature clamping diodes in an attempt to protect the device from transient voltages. ESD (\textit{Electro-static discharge}) is an example of a potentially destructive transient event! The use of external clamping diodes is common to protect for higher power transients in addition to internal clamping. 

% DRAW : a pin with diodes on it to rails inside microcontroller 

These clamping diodes will conduct current when a voltage is applied that exceeds the microcontroller's supply voltage, $V_{cc}$, and when a voltage is applied that is below the microcontroller's ground reference, $V_{ss}$. They will conduct current unless if the current becomes excessive resulting in heat and damage to the diodes and consequently damage to the device. Essentially, allowing the microcontroller to sink some current limitted overvoltage event is permissible in some cases. 

% TODO; idk should i explain the difference between TVS and clamping diode?
TVS diodes are also used. 

A disadvantage of external protection diodes is that they consume some leakage current which will result in less accurate ADC measurements. This leakage current is often difficult to model (non-linear) and can be dependent on numerous factors. Additionally, when overvolting an ADC pin you will not be receiving accurate readings.

\subsection{Analog to Digital}

% TODO : write this section
Basics of sampling theory, why you want a low pass capacitor. How to solve for cutoff frequency? 

The voltage is sampled by an ADC (\textit{Analog to Digital Converter}) into a digital value. 

Tim Wescott's article titled \bluehref{https://www.wescottdesign.com/articles/Sampling/sampling.pdf}{Sampling: What Nyquist Didnâ€™t Say, and What to Do About It} provides a deeper understanding of sampling theory! 

\subsection{Input Bias Current}
Even when an ADC is not being subjected to overvoltage, they still suffer from a non-ideality known as input bias current. Note this may also be represented by input impedance in which the load current is instead modelled by a loading resistor, however, the concept remains similar. This input bias current, $I_bias$, is in the micro-amp range and is used to feed the internal analog circuit and is present to varying degrees of severity in all forms of ADCs. This is a problem because it adds loading to our resistor divider and results in \eqref{eq:voltage_divider} being incorrect. 

% DRAW : resistor divider with I_bias loading current on V_out

\begin{equation}
    % TODO : write out the proof
    \label{eq:loaded_voltage_divider}
\end{equation} 

Using the above circuit we can solve for a new equation for $V_{out}$ shown in \eqref{eq:voltage_divider}. We can compensate for this by reducing $R_{sum}$. 
% TODO : explain why

Another method to compensate for a large input bias current is to use an external voltage buffer, aka a unity gain op-amp (\textit{Operational Amplifier}) to repeat the voltage, but buffer the current. 

% DRAW : op-amp bufferred version

% TODO : write : That amp also has input bias, compensation resistor. 

\subsection{Quiescent Current}
% TODO : write
quiescent current is current drawn when the circuit is just sitting there
can remove quiescent current of this circuit with transistors -> why is has to be high side switching
using FET or a BJT for this functionality

\subsection{Layout Considerations}
% TODO : write
low impedance net should be as small as possible to avoid noise from coupling into the signal. 
low pass capacitor should be placed near the ADC pin so it can filter out any noise that couples into the low impedance analog net. 

\end{document}
