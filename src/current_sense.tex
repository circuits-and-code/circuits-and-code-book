\documentclass[main.tex]{subfiles}
\begin{document}

\section{How would you sense how much current is flowing through a PCB to a load?}

% The source is roughly 12V and the load consumes 10 A max. 
% Choosing not to give any extra information to keep the question vague and conceptual, It could be more specific I guess, hmm 

\spoilerline

\subsection{Motivation}
Embedded systems often need to track power and current consumption of loads to:
\begin{itemize}
    \item Determine battery state of charge by integrating the power the battery has been charged and discharged with over time.
    \item Detect if a load is drawing an excessive amount of power indicating it has failed or an anomaly is occurring. 
    \item Ensure the system does not overload a source power supply which could cause the entire system to lose power. 
    \item Ensure a load is connected nominally.
\end{itemize}
Power and current are electrically related by $P = I \cdot V$. We've already seen how sense microcontroller's can sense voltages, $V$, so now we will explore current, $I$, sensing which is related to power electrically where $P = I \cdot V$.

\subsection{Resistive Current Sensing}
The simplest and most commonly used method of current sense in embedded systems is resistive current sense which leverages Ohm's Law, $I = \frac{V}{R}$, to sense the voltage drop across a known resistor value in series with the load to determine the amount of current flowing. Note that because resistors are not time or frequency dependent, resistive current sense can sense DC and AC currents. 

% DRAW : high side resistive current sense 

\subsubsection{Resistor Selection}
An important design decision for engineers is selecting the resistor to use as $R$ in this case. First we need to choose the resistance of the resistor. If the value of $R$ is too large than the resistor will dissipate excessive power as we can substitute Ohm's Law, $V=I \cdot R$, into $P=I \cdot V$ to get $P=I^{2} \cdot R$. Another issue that arises with a large $R$ value is that loads are often designed to operate with a fixed input voltage and the larger $R$ is, the larger the voltage drop induced by the series sense resistor due Ohm's Law. On the other hand, if $R$ is too small then the induced voltage drop will be so small that it becomes difficult to measure and thus precision of the current sensing can be lost. In reality values ranging from 0.1m ohm to 100 m ohm are commonly used to sense up to 100 A to 1 A of current respectively.

\subsubsection{Low Side vs High Side Sensing}
Figure x demonstrates high side current sensing, however, low side current sensing is also possible as shown in Figure y.

% DRAW: low side resistive current sense 

Low side current sensing has the advantage that regardless of the supply voltage to the load, one end of the resistor is ground so in theory only a single ended amplifier is needed. In contrast when high side sensing is used the amplifier has a variable common-mode offset and needs to amplify the differential voltage difference across the sense resistor. In reality when sensing very small voltages and high precision is required in current sensing, differential amplifiers can be used even for low side applications.

\subsubsection{Current Sense Amplifiers}
As the voltage drops across sense resistors are usually in the low mV range, amplifiers are commonly used to make the small voltage difference across the resistor much larger so a microcontroller ADC can sample it with precision. The amplifier circuits are oftentimes handled by ICs (\textit{Integrated Circuits}) that implement opamp based circuits. 
% Some common examples are: INA180, INA240

Some ICs have current sense amplifiers (\textit{CSAs}) implemented along with other functionality. 
% An example is the INA226 current sense amplifier with an ADC and I2C interface integrated in a single chip.

When selecting an amplifier, ensure it is rated for the common mode offset you intend to use it at. Additionally, amplifiers usually come with a fixed voltage gain that must be selected based on the maximum input voltage difference, $V_{id_{max}}$, and maximum ADC voltage, $V_{adc_{max}}$. 

\subsection{Magnetic Sensing}
When current flows through a wire it creates a magnetic field around it. This magnetic field can be sensed as a way to determine the current flowing. There are numerous methods of doing this that all come with different names! A simple method implemented by current clamps 
% TODO : write

\subsection{Follow-ups}
\begin{itemize}
    \item What is kelvin sense?
    \item What is a hall effect sensor?
\end{itemize}

\end{document}
